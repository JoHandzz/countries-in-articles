---
title: "figures"
format: html
editor: visual
---

## Import

```{r}
library(tidyverse)
library(rstatix) 
library(ggplot2)
library(tidytext)
library(rnaturalearth)
library(rnaturalearthdata)
library(ineq) # for making gini plot
library(ggthemes)
library(extrafont)
library(dplyr)

```

```{r}
articles_df <- read_delim("~/Desktop/Python/countries-in-articles/export_data/articles_long_format_v1.csv")
```

```{r}
# font_import()

fonts()
```

## Numbers

```{r}
# First, calculate the total number of articles for each media outlet.
# This will be our denominator for the average calculation.
total_articles_per_media <- articles_df |>
  group_by(media) |>
  summarise(total_articles = n(), .groups = 'drop')


country_analysis <- articles_df |>
  filter(countries != "NO_COUNTRIES") |>  # Har ikke fundeet et sted hvor denne var brugebar
  separate_rows(countries, sep = ",") |>
  # Clean up whitespace around country names
  mutate(countries = str_trim(countries)) |>
  count(media, countries, name = "mentions") |>
  left_join(total_articles_per_media, by = "media") |>
  mutate(mentions_per_100_articles = (mentions / total_articles) * 100) %>%
  arrange(media, desc(mentions_per_100_articles)) |>
  group_by(media) |>
  mutate(total_country_mentions = sum(mentions)) |>
  mutate(share_of_voice = ((mentions / total_country_mentions ) * 100))



# The 10 most mentioned countries for each media 


top_10_countries <- country_analysis %>%
  group_by(media) %>%
  # Select the 10 rows with the highest value in the mentions column.
  # Crucially, with_ties = FALSE breaks any ties and guarantees only 10 rows.
  slice_max(
    order_by = mentions_per_100_articles, 
    n = 10, 
    with_ties = FALSE
  ) %>%
  ungroup() # Good practice to ungroup after you're done.
  
```

Der kigges på 2 ens men også ret forskellige parametre

mentions_per_100_articles: siger sig selv. Hvis man tager 100 artikler, hvor mange gange er omtalte land så nævnt?

share_of_voice: hvor stor en andel af al land-omtale for givent medie står dette land for

```         
```

```{r}
summary_stats <- country_analysis %>%
  group_by(media) %>%
  summarise(
    n_countries = n_distinct(countries),
    more_than_once = n_distinct(countries[mentions_per_100_articles > 2]),
    gini_coefficient = Gini(mentions_per_100_articles),
    .groups = 'drop' # Recommended to drop grouping after summarise
  )

# --- Analysis 2: Calculate the "long tail" average ---
long_tail_avg <- country_analysis %>%
  group_by(media) %>%
  arrange(desc(mentions_per_100_articles)) %>%
  slice(5:n()) %>%
  summarise(
    avg_mentions = mean(mentions_per_100_articles),
    .groups = 'drop'
  )

# --- Join the two results together ---
# The 'by = "media"' argument tells the join to match rows based on the media column.
final_summary <- left_join(summary_stats, long_tail_avg, by = "media")

final_summary
  



  
    
  
```

## Plots

```{r}

colors_for_countries = c("#FFCC00","#012169","#C8102E")

media_bar <- top_10_countries |>
  mutate(country_new = str_replace_all(countries, "United States of America", "USA")) |>
  ggplot(aes(
    y = reorder_within(country_new, -mentions_per_100_articles, media), 
    x = mentions_per_100_articles,
    fill = media
  )) +
  geom_col() +
  scale_y_reordered() + # This partner function is essential
  coord_flip() +
  labs(
    title = "Top 10 Most Mentioned Countries by Media",
    # Axes are flipped, so the labels need to be swapped
    x = "Mentions per 100 articles",
    y = ""
  ) +
  theme_fivethirtyeight() +
  facet_wrap(~ media, scales = "free_x") +
  theme(
    axis.title = element_text(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    text = element_text(family = "IBM Plex Mono"),
    legend.title = element_text(size = 200),
    legend.position = "none"
  ) +
  scale_fill_manual(values = colors_for_countries )


media_bar
```

```{r}
library(forcats) 

country_analysis |>
  filter(media == 'DR') |>
  # 1. Create a factor and order the levels by the mentions_per_100_articles
  mutate(
    countries = fct_reorder(countries, mentions_per_100_articles, .desc = TRUE)
  ) |>
  arrange(desc(mentions_per_100_articles)) |>
  ggplot(aes(x = countries, y = mentions_per_100_articles)) +
  geom_point() +
  # Add theme element to handle overlapping labels
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## World map

```{r}
# 1. Aggregate data: Sum mentions for each country across all media.
country_totals_for_map <- country_analysis %>%
  filter(media == 'DR') |>
  filter(countries != 'Denmark') |>
  group_by(countries) %>%
  summarise(total_mentions = sum(mentions_per_100_articles), .groups = 'drop') %>%
  # 2. Clean country names to match the map data
  mutate(name_for_join = case_when(
    TRUE ~ countries
  ))

# 3. Get the world map spatial data
world_map <- ne_countries(scale = "medium", returnclass = "sf")

# 4. Join your mention data with the map data
world_map_data <- world_map %>%
  left_join(country_totals_for_map, by = c("name" = "name_for_join"))

# 5. Create the map plot
map_plot <- ggplot(data = world_map_data) +
  geom_sf(aes(fill = total_mentions), color = "white", size = 0.2) +
  # Use a nice color scale. `na.value` sets the color for countries with no data.
  scale_fill_viridis_c(option = "plasma", na.value = "grey90", name = "Total Mentions\nper 100 Articles") +
  labs(
    title = "DR: Mentions of Countries",
    subtitle = "Color intensity based on total mentions"
  ) +
  # Use a minimal theme for a clean map look
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", margin = margin(b = 5)),
    plot.subtitle = element_text(hjust = 0.5, size = 12, margin = margin(b = 10)),
    legend.position = "bottom",
    legend.key.width = unit(2.5, "cm"),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9)
  )

# 6. Display the map plot
print(map_plot)

```

```{r}
# 1. Aggregate data: Sum mentions for each country across all media.
country_totals_for_map <- country_analysis %>%
  filter(media == 'BBC') |>
  filter(countries != 'United Kingdom') |>
  group_by(countries) %>%
  summarise(total_mentions = sum(mentions_per_100_articles), .groups = 'drop') %>%
  # 2. Clean country names to match the map data
  mutate(name_for_join = case_when(
    TRUE ~ countries
  ))

# 3. Get the world map spatial data
world_map <- ne_countries(scale = "medium", returnclass = "sf")

# 4. Join your mention data with the map data
world_map_data <- world_map %>%
  left_join(country_totals_for_map, by = c("name" = "name_for_join"))

# 5. Create the map plot
map_plot <- ggplot(data = world_map_data) +
  geom_sf(aes(fill = total_mentions), color = "white", size = 0.2) +
  # Use a nice color scale. `na.value` sets the color for countries with no data.
  scale_fill_viridis_c(option = "plasma", na.value = "grey90", name = "Total Mentions\nper 100 Articles") +
  labs(
    title = "BBC: Mentions of Countries",
    subtitle = "Color intensity based on total mentions"
  ) +
  # Use a minimal theme for a clean map look
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", margin = margin(b = 5)),
    plot.subtitle = element_text(hjust = 0.5, size = 12, margin = margin(b = 10)),
    legend.position = "bottom",
    legend.key.width = unit(2.5, "cm"),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9)
  )

# 6. Display the map plot
print(map_plot)
```

## Violin plot

```{r}

violin_plot <- country_analysis |>
  group_by(media) |>
  arrange(desc(mentions_per_100_articles)) |>
  slice(3:n()) |> ungroup() |> # exclude top 2 countries
  ggplot(aes(
    x = mentions_per_100_articles,
    y = media,
    fill = media
  )) +
  geom_violin(alpha = 0.8) +
  # scale_x_log10() +.   # jeg synes log er dårligt her
  # Add a box 
  geom_boxplot(width = 0.1, fill = "white", outlier.shape = NA) +
  scale_x_reverse() + 
  
  # Add labels and a title
  labs(
    title = "Distribution of International News Coverage",
    subtitle = "Mentions per 100 articles for each media outlet",
    x = "Mentions per 100 Articles",
    y = "Media Outlet"
  ) +
  
  # Use a clean theme and hide the legend (y-axis labels are sufficient)
  theme_minimal() +
  theme(legend.position = "none")

# Display the plot
print(violin_plot)

```

## 

```{r}
wide_data <- country_analysis %>%
  select(countries, media, mentions_per_100_articles) %>%
  pivot_wider(
    names_from = media,
    values_from = mentions_per_100_articles,
    values_fill = 0
  )


correlation_matrix <- wide_data %>%
  select(-countries) %>%
  cor(method = "spearman")

correlation_matrix[upper.tri(correlation_matrix, diag = TRUE)] <- NA


correlation_long <- as.data.frame(correlation_matrix) %>%
  tibble::rownames_to_column("media1") %>%
  pivot_longer(
    cols = -media1,
    names_to = "media2",
    values_to = "correlation"
  ) %>%
  # Remove the NA rows to only plot the lower triangle
  filter(!is.na(correlation))



print(correlation_long)
```
