---
title: "Analysis of Country Mentions in DR, BBC and ARD"
format:
  pdf:
    toc: true                
    number-sections: true   
    geometry: "margin=1in"   
execute:
  echo: false      
---

# Set-up

```{r}
#| label: setup
#| echo: false
#| message: false
#| warning: false


library(tidyverse)
library(rstatix) 
library(ggplot2)
library(tidytext)
library(tidyr)
library(rnaturalearth)
library(rnaturalearthdata)
library(ineq) # for making gini 
library(ggthemes)
library(extrafont)
library(dplyr)
library(psych)
library(sf)



```

Dataen rengøres således at der for hvert medie er samme antal artikler per dag.

```{r}
articles_df <- read_delim("~/Desktop/Python/countries-in-articles/export_data/articles_long_format_v1.csv") |>
  filter(!(type_article%in% c('sport','sporten')))|>
  add_count(media, date, name = "n_articles_per_media") |>
  group_by(date) |>
  mutate(min_daily_count = min(n_articles_per_media)) |>
  ungroup() |>
  filter(min_daily_count > 10) |>
  group_by(media, date) |>
  mutate(row_num = row_number()) |>
  filter(row_num <= min_daily_count) |>
  ungroup() |>
  select(-n_articles_per_media, -min_daily_count, -row_num)


glimpse(articles_df)
  
```

I denne analyse medtages 828 artikler

```{r}
# font_import()
# fonts("IBM Plex Mono")
```

# Numbers

## dataframes

### country_analysis

```{r}
# First, calculate the total number of articles for each media outlet.
# This will be our denominator for the average calculation.
total_articles_per_media <- articles_df |>
  group_by(media) |>
  summarise(total_articles = n(), .groups = 'drop')


country_analysis <- articles_df |>
  filter(countries != "NO_COUNTRIES") |>  # Har ikke fundeet et sted hvor disse var brugebar
  separate_rows(countries, sep = ",") |>
  mutate(countries = str_trim(countries)) |>
  count(media, countries, name = "mentions") |>
  left_join(total_articles_per_media, by = "media") |>
  mutate(mentions_per_100_articles = (mentions / total_articles) * 100) %>%
  arrange(media, desc(mentions_per_100_articles)) |>
  group_by(media) |>
  mutate(total_country_mentions = sum(mentions)) |>
  mutate(share_of_voice = ((mentions / total_country_mentions ) * 100))



# The 10 most mentioned countries for each media 


top_10_countries <- country_analysis |>
  group_by(media) |>
  slice_max(
    order_by = mentions_per_100_articles, 
    n = 10, 
    with_ties = FALSE
  ) |>
  ungroup() # Good practice to ungroup after you're done.

glimpse(country_analysis)
  
```

Der kigges på 2 ens men også ret forskellige parametre

mentions_per_100_articles: siger sig selv. Hvis man tager 100 artikler, hvor mange gange er omtalte land så nævnt?

share_of_voice: hvor stor en andel af al land-omtale for givent medie står dette land for

### per_day

```{r}
per_day <- articles_df |>
  filter(countries != "NO_COUNTRIES") |>  
  group_by(media,date) |>
  separate_rows(countries, sep = ",") |>
  summarise(n_countries = n_distinct(countries), .groups = 'drop') 

  
```

### countries_as_placings

```{r}
countries_as_placings <- country_analysis |>
  group_by(media) |>
  arrange(desc(mentions_per_100_articles), .by_group = TRUE) %>%
  mutate(placing = row_number()) |>
  select(media, placing, countries, mentions_per_100_articles) |>
  ungroup()

# Display the head of the new data frame
glimpse(countries_as_placings)
```

## Summaries

```{r}
summary_stats <- country_analysis %>%
  group_by(media) %>%
  summarise(
    n_countries = n_distinct(countries),
    more_than_once = n_distinct(countries[mentions_per_100_articles > 1]),
    gini_coefficient = Gini(mentions_per_100_articles),
    .groups = 'drop' 
  )


long_tail_avg <- country_analysis %>%
  group_by(media) %>%
  arrange(desc(mentions_per_100_articles)) %>%
  slice(5:n()) %>%
  summarise(
    avg_mentions = mean(mentions_per_100_articles),
    .groups = 'drop'
  )


final_summary <- left_join(summary_stats, long_tail_avg, by = "media")

final_summary
  
```

Generelle stats for hvert medie:

1.  n_countries: antal af unikke lande nævnt i alle artiklerne

2.  more_than_once: antal af unikke lande nævnt mere end 1 gang per 100 artikler

3.  gini_coefficent: parametre fra økonomi, 0 er perfekt lighed og 1 maximum ulighed

4.  avg_mentions: gennemsnitligt antal gange en lande bliver nævnt per 100 artikel (4 mest nævnt labde frasorteret)

# Plots

## Barplot - top 10

```{r}

colors_for_countries = c("#FFCC00","#012169","#C8102E")

media_bar <- top_10_countries |>
  mutate(country_new = str_replace_all(countries, "United States of America", "USA")) |>
  ggplot(aes(
    y = reorder_within(country_new, -mentions_per_100_articles, media), 
    x = mentions_per_100_articles,
    fill = media
  )) +
  geom_col() +
  scale_y_reordered() + # This partner function is essential
  coord_flip() +
  labs(
    title = "Top 10 Most Mentioned Countries by Media",
    # Axes are flipped, so the labels need to be swapped
    x = "Mentions per 100 articles",
    y = ""
  ) +
  theme_fivethirtyeight() +
  facet_wrap(~ media, scales = "free_x") +
  theme(
    axis.title = element_text(),
    axis.text.x = element_text(angle = 45, hjust = 1),
    text = element_text(family = "IBM Plex Mono"),
    legend.title = element_text(size = 200),
    legend.position = "none"
  ) +
  scale_fill_manual(values = colors_for_countries )


media_bar
```

## Barplot - unique countries per day

```{r}
per_day |>
  group_by(media) |>
  summarise(mean_val = mean(n_countries), sd_val = sd(n_countries), .groups = 'drop') |>
  ggplot(aes(x = media, y = mean_val, fill = media)) +
  # Use 'geom_col()' for pre-summarised data
  geom_col(width = 0.7, color = "black", linewidth = 0.5) +
  geom_errorbar(aes(ymin = mean_val - sd_val, ymax = mean_val + sd_val),
    width = 0.3, linewidth = 1.2, alpha = 0.8,color = "black" ) +
  labs(
    title = "Daily Number of Unique Countries",
    y = "Average Unique Countries per Day", 
    x = "Media Outlet" 
  ) +
  geom_text(
    aes(label = round(mean_val, 1), y = mean_val / 2),
    color = "white",
    vjust = 0.5, 
    fontface = "bold",
    size = 6
  ) +
  theme_fivethirtyeight() +
  theme(
    axis.title.x = element_blank(),
    axis.title = element_text(),
    text = element_text(family = "IBM Plex Mono"),
    legend.title = element_text(size = 200),
    legend.position = "none"
  ) +
  scale_fill_manual(values = colors_for_countries )


```

Undersøg om der er signifikant forskel:

```{r}

anova_result1 <- per_day |>
  anova_test(
    formula = n_countries ~ media, # Test the effect of 'media' on 'n_countries'
    effect.size = "pes"
  )

get_anova_table(anova_result1)
```

```{r}

# DR vs. ARD 
t_test_DR_ARD <- per_day |>
  filter(media %in% c("DR", "ARD")) |>
  anova_test(
    formula = n_countries ~ media, # Test the effect of 'media' on 'n_countries'
    effect.size = "pes"
  )

get_anova_table(t_test_DR_ARD)


# DR vs. BBC 
t_test_DR_BBC <- per_day |>
  filter(media %in% c("DR", "BBC")) |>
  anova_test(
    formula = n_countries ~ media, # Test the effect of 'media' on 'n_countries'
    effect.size = "pes"
  )

print(get_anova_table(t_test_DR_BBC))

```

Her er en indsigt:

**DR skriver om signifikant færre unikke lande end de to andre medier**

## Decay plot

Lad os kigge på fordelingen af mentions

```{r}
decay_plot <- countries_as_placings |>
  ggplot(aes(
    x = placing, 
    y = mentions_per_100_articles, 
    color = media, 
    group = media
  )) +
  geom_line(linewidth = 1.2, alpha = 0.5) +
  geom_point(size = 1.5, alpha = 0.8) +
  scale_color_manual(
    values = c("BBC" = "#012169", "DR" = "#C8102E", "ARD"="#FFCC00")) +
  labs(
    title = "Distribution of Country Ranks",
    x = "Country Rank (Placing)",
    y = "Mentions per 100 Articles",
    color = "Media Outlet" # This sets the legend title
  ) +
  theme_fivethirtyeight() +
  theme(
    axis.title = element_text(),
    legend.position = "bottom",
    text = element_text(family = "IBM Plex Mono"),
  )

# Display the plot
print(decay_plot)
```

Der zoomes ind, ved at frasortere 3 mest nævnte lande fra hvert medie

```{r}
decay_plot2 <- countries_as_placings |>
   group_by(media) |>
  arrange(desc(mentions_per_100_articles)) |>
  slice(4:n()) |> ungroup() |>
  ggplot(aes(
    x = placing, 
    y = mentions_per_100_articles, 
    color = media, 
    group = media
  )) +
  geom_line(linewidth = 1.2, alpha = 0.5) +
  geom_point(size = 1.5, alpha = 0.5) +
  scale_color_manual(
    values = c("BBC" = "#012169", "DR" = "#C8102E", "ARD"="#FFCC00")) +
  labs(
    title = "Distribution of Country Ranks",
    subtitle = "Excluding top 3 countries for each media",
    x = "Country Rank (Placing)",
    y = "Mentions per 100 Articles",
    color = "Media Outlet" # This sets the legend title
  ) +
  theme_fivethirtyeight() +
  theme(
    axis.title = element_text(),
    legend.position = "bottom",
    text = element_text(family = "IBM Plex Mono"),
  )

# Display the plot
print(decay_plot2)
```

DR omtaler færre lande end de to andre medier i alle dele af fordelingen.

## World maps

### DR

```{r}
country_totals_for_map <- country_analysis |>
  filter(media == 'DR') |>
  mutate(mentions_per_100_articles = case_when(
    mentions_per_100_articles > 25 ~ 25,
    TRUE ~ mentions_per_100_articles  # more than 25 mentions = 25 menttions
  )) |>
  group_by(countries) |>
  summarise(total_mentions = sum(mentions_per_100_articles), .groups = 'drop') |>
  mutate(name_for_join = case_when(
    TRUE ~ countries
  ))

world_map <- ne_countries(scale = "medium", returnclass = "sf")


world_map_data <- world_map %>%
  left_join(country_totals_for_map, by = c("name" = "name_for_join"))

# Create the map plot
map_plot <- ggplot(data = world_map_data) +
  geom_sf(aes(fill = total_mentions), color = "white", size = 0.2) +
  scale_fill_viridis_c(
    option = "turbo", 
    na.value = "grey90", 
    name = "Total Mentions\nper 100 Articles"
  ) +
  labs(
    title = "DR: Mentions of Countries",
    caption = "Dark red indicates 25 or more mentions"
  ) +
  theme_void() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", margin = margin(b = 5)),
    plot.subtitle = element_text(hjust = 0.5, size = 12, margin = margin(b = 10)),
    legend.position = "bottom",
    legend.key.width = unit(2.5, "cm"),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9),
    text = element_text(family = "IBM Plex Mono")
  )

# 5. Display the map plot
print(map_plot)

```

### BBC

```{r}
country_totals_for_map <- country_analysis |>
  filter(media == 'BBC') |>
  mutate(mentions_per_100_articles = case_when(
    mentions_per_100_articles > 25 ~ 25,
    TRUE ~ mentions_per_100_articles  # more than 25 mentions = 25 menttions
  )) |>
  group_by(countries) |>
  summarise(total_mentions = sum(mentions_per_100_articles), .groups = 'drop') |>
  mutate(name_for_join = case_when(
    TRUE ~ countries
  ))

world_map <- ne_countries(scale = "medium", returnclass = "sf")


world_map_data <- world_map %>%
  left_join(country_totals_for_map, by = c("name" = "name_for_join"))

# Create the map plot
map_plot <- ggplot(data = world_map_data) +
  geom_sf(aes(fill = total_mentions), color = "white", size = 0.2) +
  scale_fill_viridis_c(
    option = "turbo", 
    na.value = "grey90", 
    name = "Total Mentions\nper 100 Articles"
  ) +
  labs(
    title = "BBC: Mentions of Countries",
    caption = "Dark red indicates 25 or more mentions"
  ) +
  theme_void() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", margin = margin(b = 5)),
    plot.subtitle = element_text(hjust = 0.5, size = 12, margin = margin(b = 10)),
    legend.position = "bottom",
    legend.key.width = unit(2.5, "cm"),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9),
    text = element_text(family = "IBM Plex Mono")
  )

# 5. Display the map plot
print(map_plot)

```

### ARD

```{r}
country_totals_for_map <- country_analysis |>
  filter(media == 'ARD') |>
  mutate(mentions_per_100_articles = case_when(
    mentions_per_100_articles > 25 ~ 25,
    TRUE ~ mentions_per_100_articles  # more than 25 mentions = 25 menttions
  )) |>
  group_by(countries) |>
  summarise(total_mentions = sum(mentions_per_100_articles), .groups = 'drop') |>
  mutate(name_for_join = case_when(
    TRUE ~ countries
  ))

world_map <- ne_countries(scale = "medium", returnclass = "sf")


world_map_data <- world_map %>%
  left_join(country_totals_for_map, by = c("name" = "name_for_join"))

# Create the map plot
map_plot <- ggplot(data = world_map_data) +
  geom_sf(aes(fill = total_mentions), color = "white", size = 0.2) +
  scale_fill_viridis_c(
    option = "turbo", 
    na.value = "grey90", 
    name = "Total Mentions\nper 100 Articles"
  ) +
  labs(
    title = "ARD: Mentions of Countries",
    caption = "Dark red indicates 25 or more mentions"
  ) +
  theme_void() + 
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold", margin = margin(b = 5)),
    plot.subtitle = element_text(hjust = 0.5, size = 12, margin = margin(b = 10)),
    legend.position = "bottom",
    legend.key.width = unit(2.5, "cm"),
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9),
    text = element_text(family = "IBM Plex Mono")
  )

# 5. Display the map plot
print(map_plot)
```

## Violin plot

Det her plot siger ikke så meget

```{r}

violin_plot <- country_analysis |>
  group_by(media) |>
  arrange(desc(mentions_per_100_articles)) |>
  slice(3:n()) |> ungroup() |>
  ggplot(aes(
    x = mentions_per_100_articles,
    y = media,
    fill = media
  )) +
  geom_violin(alpha = 0.8) +
  geom_boxplot(width = 0.1, fill = "white", outlier.shape = NA) +
  scale_x_reverse() + 
  labs(
    title = "Distribution of International News Coverage",
    subtitle = "Excluding top 3 most mentioned countries",
    x = "Mentions per 100 Articles",
    y = "Media Outlet"
  ) +
  theme_fivethirtyeight() +
  theme(
    axis.title = element_text(),
    axis.title.y = element_blank(),
    text = element_text(family = "IBM Plex Mono"),
    legend.title = element_text(size = 200),
    legend.position = "none"
  ) +
  scale_fill_manual(values = colors_for_countries )
  


violin_plot

```

## Correlation

```{r}
wide_data <- country_analysis %>%
  select(countries, media, mentions_per_100_articles) %>%
  pivot_wider(
    names_from = media,
    values_from = mentions_per_100_articles,
    values_fill = 0
  )


correlation_matrix <- wide_data %>%
  select(-countries) %>%
  cor(method = "spearman")

correlation_matrix[upper.tri(correlation_matrix, diag = TRUE)] <- NA


correlation_long <- as.data.frame(correlation_matrix) %>%
  tibble::rownames_to_column("media1") %>%
  pivot_longer(
    cols = -media1,
    names_to = "media2",
    values_to = "correlation"
  ) %>%
  # Remove the NA rows to only plot the lower triangle
  filter(!is.na(correlation))



print(correlation_long)
```

Indsigt: DR og ARD skriver om meget ens lande
